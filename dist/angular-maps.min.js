/**
 * AngularGM - Google Maps Directives for AngularJS
 * @version v1.0.0 - 2015-01-14
 * @link https://github.com/dmcquillan314/angular-maps
 * @author Dan McQuillan <dmcquillan314@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
angular.module("angular-maps",[]),angular.module("angular-maps").directive("map",["$parse",function(){return{restrict:"AE",transclude:!0,priority:100,template:'<div class="angular-google-map"><div class="angular-google-map-container"></div><div ng-transclude style="display: none"></div></div>',replace:!0,controller:"MapController"}}]),angular.module("angular-maps").directive("marker",["$parse",function(a){return{restrict:"E",require:"^map",priority:100,link:function(b,c,d,e){var f={clickable:!0,crossOnDrag:!0,draggable:!1,opacity:1,visible:!0},g=a(d.events)(b),h=a(d.options)(b),i=a(d.position)(b),j=d.content?a(d.content)(b):null,k=d.control?a(d.control)(b):{},l=d.model?a(d.model):void 0,m=null,n=function(){google.maps.event.clearInstanceListeners(m)},o=function(){angular.forEach(g,function(a,c){google.maps.event.addListener(m,c,function(d){l&&(m.model=l(b)||void 0),a(m,c,d)})})};angular.extend(h,f),h.position=new google.maps.LatLng(i.latitude,i.longitude),h.content=j,m=e.addMarker(h,!0),o(),k.getMarker=function(){return m},b.$on("$destroy",function(){e.removeMarker(h,!0)}),b.$watch(d.events,function(a){n(),g=a,o()}),b.$watch(d.position,function(a){n(),e.removeMarker(h,!0),h.position=new google.maps.LatLng(a.latitude,a.longitude),m=e.addMarker(h,!0),o()}),b.$watch(d.content,function(a){n(),e.removeMarker(h,!1),h.content=a,m=e.addMarker(h,!1),o()})}}}]),angular.module("angular-maps").factory("DefaultMarkerFactory",[function(){var a={};return a.createMarker=function(a){return new google.maps.Marker(a)},a}]).factory("RichMarkerFactory",["$window",function(a){var b={},c=function(){function a(a){var c=a||{};this.ready_=!1,this.dragging_=!1,void 0===a.visible&&(a.visible=!0),void 0===a.shadow&&(a.shadow="7px -3px 5px rgba(88,88,88,0.7)"),void 0===a.anchor&&(a.anchor=b.BOTTOM),this.setValues(c)}a.prototype=new google.maps.OverlayView,window.RichMarker=a,a.prototype.getVisible=function(){return this.get("visible")},a.prototype.getVisible=a.prototype.getVisible,a.prototype.setVisible=function(a){this.set("visible",a)},a.prototype.setVisible=a.prototype.setVisible,a.prototype.visible_changed=function(){this.ready_&&(this.markerWrapper_.style.display=this.getVisible()?"":"none",this.draw())},a.prototype.visible_changed=a.prototype.visible_changed,a.prototype.setFlat=function(a){this.set("flat",!!a)},a.prototype.setFlat=a.prototype.setFlat,a.prototype.getFlat=function(){return this.get("flat")},a.prototype.getFlat=a.prototype.getFlat,a.prototype.getWidth=function(){return this.get("width")},a.prototype.getWidth=a.prototype.getWidth,a.prototype.getHeight=function(){return this.get("height")},a.prototype.getHeight=a.prototype.getHeight,a.prototype.setShadow=function(a){this.set("shadow",a),this.flat_changed()},a.prototype.setShadow=a.prototype.setShadow,a.prototype.getShadow=function(){return this.get("shadow")},a.prototype.getShadow=a.prototype.getShadow,a.prototype.flat_changed=function(){this.ready_&&(this.markerWrapper_.style.boxShadow=this.markerWrapper_.style.webkitBoxShadow=this.markerWrapper_.style.MozBoxShadow=this.getFlat()?"":this.getShadow())},a.prototype.flat_changed=a.prototype.flat_changed,a.prototype.setZIndex=function(a){this.set("zIndex",a)},a.prototype.setZIndex=a.prototype.setZIndex,a.prototype.getZIndex=function(){return this.get("zIndex")},a.prototype.getZIndex=a.prototype.getZIndex,a.prototype.zIndex_changed=function(){this.getZIndex()&&this.ready_&&(this.markerWrapper_.style.zIndex=this.getZIndex())},a.prototype.zIndex_changed=a.prototype.zIndex_changed,a.prototype.getDraggable=function(){return this.get("draggable")},a.prototype.getDraggable=a.prototype.getDraggable,a.prototype.setDraggable=function(a){this.set("draggable",!!a)},a.prototype.setDraggable=a.prototype.setDraggable,a.prototype.draggable_changed=function(){this.ready_&&(this.getDraggable()?this.addDragging_(this.markerWrapper_):this.removeDragListeners_())},a.prototype.draggable_changed=a.prototype.draggable_changed,a.prototype.getPosition=function(){return this.get("position")},a.prototype.getPosition=a.prototype.getPosition,a.prototype.setPosition=function(a){this.set("position",a)},a.prototype.setPosition=a.prototype.setPosition,a.prototype.position_changed=function(){this.draw()},a.prototype.position_changed=a.prototype.position_changed,a.prototype.getAnchor=function(){return this.get("anchor")},a.prototype.getAnchor=a.prototype.getAnchor,a.prototype.setAnchor=function(a){this.set("anchor",a)},a.prototype.setAnchor=a.prototype.setAnchor,a.prototype.anchor_changed=function(){this.draw()},a.prototype.anchor_changed=a.prototype.anchor_changed,a.prototype.htmlToDocumentFragment_=function(a){var b=document.createElement("DIV");if(b.innerHTML=a,1===b.childNodes.length)return b.removeChild(b.firstChild);for(var c=document.createDocumentFragment();b.firstChild;)c.appendChild(b.firstChild);return c},a.prototype.removeChildren_=function(a){if(a)for(var b;b=a.firstChild;)a.removeChild(b)},a.prototype.setContent=function(a){this.set("content",a)},a.prototype.setContent=a.prototype.setContent,a.prototype.getContent=function(){return this.get("content")},a.prototype.getContent=a.prototype.getContent,a.prototype.content_changed=function(){if(this.markerContent_){this.removeChildren_(this.markerContent_);var a=this.getContent();if(a){"string"==typeof a&&(a=a.replace(/^\s*([\S\s]*)\b\s*$/,"$1"),a=this.htmlToDocumentFragment_(a)),this.markerContent_.appendChild(a);for(var b,c=this,d=this.markerContent_.getElementsByTagName("IMG"),e=function(){"use strict";return function(a){c.getDraggable()&&(null!==a&&a.preventDefault&&a.preventDefault(),a.returnValue=!1)}},f=function(){"use strict";return function(){c.draw()}},g=0;b=d[g];g++)google.maps.event.addDomListener(b,"mousedown",e()),google.maps.event.addDomListener(b,"load",f());google.maps.event.trigger(this,"domready")}this.ready_&&this.draw()}},a.prototype.content_changed=a.prototype.content_changed,a.prototype.setCursor_=function(a){if(this.ready_){var b="";-1!==navigator.userAgent.indexOf("Gecko/")?("dragging"===a&&(b="-moz-grabbing"),"dragready"===a&&(b="-moz-grab"),"draggable"===a&&(b="pointer")):(("dragging"===a||"dragready"===a)&&(b="move"),"draggable"===a&&(b="pointer")),this.markerWrapper_.style.cursor!==b&&(this.markerWrapper_.style.cursor=b)}},a.prototype.startDrag=function(a){if(this.getDraggable()&&!this.dragging_){this.dragging_=!0;var b=this.getMap();this.mapDraggable_=b.get("draggable"),b.set("draggable",!1),this.mouseX_=a.clientX,this.mouseY_=a.clientY,this.setCursor_("dragready"),this.markerWrapper_.style.MozUserSelect="none",this.markerWrapper_.style.KhtmlUserSelect="none",this.markerWrapper_.style.WebkitUserSelect="none",this.markerWrapper_.unselectable="on",this.markerWrapper_.onselectstart=function(){return!1},this.addDraggingListeners_(),google.maps.event.trigger(this,"dragstart")}},a.prototype.stopDrag=function(){this.getDraggable()&&this.dragging_&&(this.dragging_=!1,this.getMap().set("draggable",this.mapDraggable_),this.mouseX_=this.mouseY_=this.mapDraggable_=null,this.markerWrapper_.style.MozUserSelect="",this.markerWrapper_.style.KhtmlUserSelect="",this.markerWrapper_.style.WebkitUserSelect="",this.markerWrapper_.unselectable="off",this.markerWrapper_.onselectstart=function(){},this.removeDraggingListeners_(),this.setCursor_("draggable"),google.maps.event.trigger(this,"dragend"),this.draw())},a.prototype.drag=function(a){if(!this.getDraggable()||!this.dragging_)return void this.stopDrag();var b=this.mouseX_-a.clientX,c=this.mouseY_-a.clientY;this.mouseX_=a.clientX,this.mouseY_=a.clientY;var d=parseInt(this.markerWrapper_.style.left,10)-b,e=parseInt(this.markerWrapper_.style.top,10)-c;this.markerWrapper_.style.left=d+"px",this.markerWrapper_.style.top=e+"px";var f=this.getOffset_(),g=new google.maps.Point(d-f.width,e-f.height),h=this.getProjection();this.setPosition(h.fromDivPixelToLatLng(g)),this.setCursor_("dragging"),google.maps.event.trigger(this,"drag")},a.prototype.removeDragListeners_=function(){this.draggableListener_&&(google.maps.event.removeListener(this.draggableListener_),delete this.draggableListener_),this.setCursor_("")},a.prototype.addDragging_=function(a){if(a){var b=this;this.draggableListener_=google.maps.event.addDomListener(a,"mousedown",function(a){b.startDrag(a)}),this.setCursor_("draggable")}},a.prototype.addDraggingListeners_=function(){var a=this;this.markerWrapper_.setCapture?(this.markerWrapper_.setCapture(!0),this.draggingListeners_=[google.maps.event.addDomListener(this.markerWrapper_,"mousemove",function(b){a.drag(b)},!0),google.maps.event.addDomListener(this.markerWrapper_,"mouseup",function(){a.stopDrag(),a.markerWrapper_.releaseCapture()},!0)]):this.draggingListeners_=[google.maps.event.addDomListener(window,"mousemove",function(b){a.drag(b)},!0),google.maps.event.addDomListener(window,"mouseup",function(){a.stopDrag()},!0)]},a.prototype.removeDraggingListeners_=function(){if(this.draggingListeners_){for(var a,b=0;a=this.draggingListeners_[b];b++)google.maps.event.removeListener(a);this.draggingListeners_.length=0}},a.prototype.getOffset_=function(){var a=this.getAnchor();if("object"==typeof a)return a;var c=new google.maps.Size(0,0);if(!this.markerContent_)return c;var d=this.markerContent_.offsetWidth,e=this.markerContent_.offsetHeight;switch(a){case b.TOP_LEFT:break;case b.TOP:c.width=-d/2;break;case b.TOP_RIGHT:c.width=-d;break;case b.LEFT:c.height=-e/2;break;case b.MIDDLE:c.width=-d/2,c.height=-e/2;break;case b.RIGHT:c.width=-d,c.height=-e/2;break;case b.BOTTOM_LEFT:c.height=-e;break;case b.BOTTOM:c.width=-d/2,c.height=-e;break;case b.BOTTOM_RIGHT:c.width=-d,c.height=-e}return c},a.prototype.onAdd=function(){if(this.markerWrapper_||(this.markerWrapper_=document.createElement("DIV"),this.markerWrapper_.style.position="absolute"),this.getZIndex()&&(this.markerWrapper_.style.zIndex=this.getZIndex()),this.markerWrapper_.style.display=this.getVisible()?"":"none",!this.markerContent_){this.markerContent_=document.createElement("DIV"),this.markerWrapper_.appendChild(this.markerContent_);var a=this;google.maps.event.addDomListener(this.markerContent_,"click",function(){google.maps.event.trigger(a,"click")}),google.maps.event.addDomListener(this.markerContent_,"mouseover",function(){google.maps.event.trigger(a,"mouseover")}),google.maps.event.addDomListener(this.markerContent_,"mouseout",function(){google.maps.event.trigger(a,"mouseout")})}this.ready_=!0,this.content_changed(),this.flat_changed(),this.draggable_changed();var b=this.getPanes();b&&b.overlayMouseTarget.appendChild(this.markerWrapper_),google.maps.event.trigger(this,"ready")},a.prototype.onAdd=a.prototype.onAdd,a.prototype.draw=function(){if(this.ready_&&!this.dragging_){var a=this.getProjection();if(a){var b=this.get("position"),c=a.fromLatLngToDivPixel(b),d=this.getOffset_();this.markerWrapper_.style.top=c.y+d.height+"px",this.markerWrapper_.style.left=c.x+d.width+"px";var e=this.markerContent_.offsetHeight,f=this.markerContent_.offsetWidth;f!==this.get("width")&&this.set("width",f),e!==this.get("height")&&this.set("height",e)}}},a.prototype.draw=a.prototype.draw,a.prototype.onRemove=function(){this.markerWrapper_&&this.markerWrapper_.parentNode&&this.markerWrapper_.parentNode.removeChild(this.markerWrapper_),this.removeDragListeners_()},a.prototype.onRemove=a.prototype.onRemove;var b={TOP_LEFT:1,TOP:2,TOP_RIGHT:3,LEFT:4,MIDDLE:5,RIGHT:6,BOTTOM_LEFT:7,BOTTOM:8,BOTTOM_RIGHT:9};window.RichMarkerPosition=b};return b.createMarker=function(d){if(!a.google)throw new Error("MarkerFactory.createMarker: google is not defined.");return a.RichMarker?new window.RichMarker(d):(c(),b.createMarker(d))},b}]).factory("MarkerFactory",["DefaultMarkerFactory","RichMarkerFactory",function(a,b){var c={};return c.createMarker=function(c){return angular.isDefined(c.content)&&null!==c.content?b.createMarker(c):a.createMarker(c)},c}]),angular.module("angular-maps").controller("MapController",["$scope","$parse","$element","$attrs","MarkerFactory",function(a,b,c,d,e){var f=this,g=b(d.events)(a),h={zoom:b(d.zoom)(a)},i=[],j=b(d.center)(a),k=d.pan?b(d.pan)(a):!1,l=new google.maps.Map(c[0].firstChild,h),m=d.control?b(d.control)(a):{};m.getMap=function(){return l};var n=function(){google.maps.event.clearInstanceListeners(l)},o=function(){angular.forEach(g,function(a,b){google.maps.event.addListener(b,function(c){a(l,b,c)})})},p=function(){for(var a=new google.maps.LatLngBounds,b=0;b<i.length;b++){var c=i[b];a.extend(c.position)}k?l.panToBounds(a):l.fitBounds(a)},q=function(){var a=new google.maps.LatLng(parseFloat(j.latitude,10),parseFloat(j.longitude,10));k?l.panTo(a):l.setCenter(a)};f.addMarker=function(a,b){var c="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)});a._id=c,a.map=l;var d=e.createMarker(a);return i.push(d),b&&p(),d},f.removeMarker=function(a,b){for(var c=a._id,d=null,e=null,f=0;f<i.length;f++)if(i[f]._id===c){d=i[f],e=f;break}d.setMap(null),i.splice(e,1),b&&p()},q(),a.$watch(d.center,function(a){j=a,q()},!0),a.$watch(d.events,function(a){n(),g=a,o()})}]);